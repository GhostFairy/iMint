<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="multi.fclass.iMint.mypage.dao.IMypageDAO">
	<select id="selectWishList" parameterType="Map" resultType="WishListDTO">
		SELECT
			category,
		    goods_id,
		    goods_title,
		    goods_price,
		    goods_location,
		    goods_create_date,
		    goods_images_path,
		    goods_images_originname
		FROM
		    ((SELECT
				"resrv" AS category,
				g.goods_id,
				g.goods_title,
				g.goods_price,
				g.goods_location,
				g.goods_create_date,
				gi.goods_images_path,
				gi.goods_images_originname,
				cr.chat_room_resrv_date AS sortdate
			FROM
				(`imint`.`chat_room` AS cr JOIN `imint`.`goods` AS g ON cr.goods_id = g.goods_id)
				JOIN (SELECT * FROM `imint`.`goods_images` WHERE goods_images_thumbnail = TRUE) AS gi ON g.goods_id = gi.goods_id
			WHERE
				cr.mb_id LIKE #{myId}
				AND g.goods_isdelete = FALSE
				AND (cr.chat_room_isdelete = FALSE OR cr.chat_room_isdelete IS NULL)
				AND cr.chat_room_resrv_date IS NOT NULL)
			UNION ALL
			(SELECT
				CASE
					WHEN g.goods_status = "wait" THEN "wait"
					WHEN g.goods_status = "resrv" THEN "!resrv"
					WHEN g.goods_status = "comp" THEN IF(trx.mb_id LIKE #{myId}, "comp", "!comp")
				END AS category,
				g.goods_id,
				g.goods_title,
				g.goods_price,
				g.goods_location,
				g.goods_create_date,
				gi.goods_images_path,
				gi.goods_images_originname,
		        w.wishlist_create_date AS sortdate
			FROM
				(((`imint`.`wishlist` AS w JOIN `imint`.`goods` AS g ON w.goods_id = g.goods_id)
				JOIN (SELECT * FROM `imint`.`goods_images` WHERE goods_images_thumbnail = TRUE) AS gi ON g.goods_id = gi.goods_id)
				LEFT JOIN `imint`.`transaction` AS trx ON g.goods_id = trx.goods_id)
				LEFT JOIN `imint`.`chat_room` AS cr ON g.goods_id = cr.goods_id
			WHERE
				w.mb_id LIKE #{myId}
				AND w.wishlist_isdelete = FALSE
				AND g.goods_isdelete = FALSE
				AND (trx_isdelete = FALSE OR trx.trx_isdelete IS NULL)
				AND (cr.chat_room_isdelete = FALSE OR cr.chat_room_isdelete IS NULL)))
			AS result
		ORDER BY
			sortdate DESC
		LIMIT
			#{startIndex}, #{numberOfItems}
	</select>
	<select id="selectSellingList" parameterType="Map" resultType="SellingListDTO">
		SELECT
			IF(g.goods_status = "wait", "wait", "resrv") AS category,
			g.goods_id,
			g.goods_title,
			g.goods_price,
			g.goods_location,
			g.goods_create_date,
			gi.goods_images_path,
			gi.goods_images_originname
		FROM
			`imint`.`goods` AS g JOIN (SELECT * FROM `imint`.`goods_images` WHERE goods_images_thumbnail = TRUE) AS gi ON g.goods_id = gi.goods_id
		WHERE
			g.mb_id LIKE #{myId}
			AND (g.goods_status = "wait" OR g.goods_status = "resrv")
		ORDER BY
			g.goods_create_date DESC
		LIMIT
			#{startIndex}, #{numberOfItems}
	</select>
	<select id="selectCompleteList" parameterType="Map" resultType="CompleteListDTO">
		SELECT
			IF(trx.mb_id LIKE #{myId}, "buy", "sell") AS category,
			g.goods_id,
			g.goods_title,
			g.goods_price,
			g.goods_location,
			gi.goods_images_path,
			gi.goods_images_originname,
			trx.trx_complete_date,
			r.rating_id
		FROM
			((`imint`.`transaction` AS trx JOIN `imint`.`goods` AS g ON trx.goods_id = g.goods_id)
			JOIN (SELECT * FROM `imint`.`goods_images` WHERE goods_images_thumbnail = TRUE) AS gi ON g.goods_id = gi.goods_id)
			LEFT JOIN (SELECT * FROM `imint`.`rating` WHERE mb_id LIKE #{myId}) AS r ON trx.trx_id = r.trx_id
		WHERE
			trx.mb_id LIKE #{myId} OR g.mb_id LIKE #{myId}
		ORDER BY
			trx.trx_complete_date DESC
		LIMIT
			#{startIndex}, #{numberOfItems}
	</select>
</mapper>